<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f3caca;
  background:
    linear-gradient(rgba(0,0,0,.82), rgba(0,0,0,.95)),
    url("/static/bg.jpg") center/cover no-repeat fixed;
}

/* ===== CLOCK ===== */
#clockBox{
  position:fixed;
  top:20px;
  right:30px;
  text-align:right;
  z-index:3000;
  color:#ff6a6a;
  text-shadow:0 0 15px rgba(255,0,0,.7);
}
#clockTime{font-size:32px;font-weight:700}
#clockDate{font-size:16px;opacity:.85}

/* ===== INTRO ===== */
#intro{
  position:fixed;
  inset:0;
  background:
    linear-gradient(rgba(0,0,0,.6), rgba(0,0,0,.85)),
    url("/static/bg.jpg") center/cover no-repeat;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#intro img{
  width:480px;
  max-width:90%;
  opacity:0;
  transform:scale(.85);
  animation:introIn 1.8s forwards;
}
@keyframes introIn{
  0%{opacity:0;transform:scale(.85)}
  60%{opacity:1;transform:scale(1.05)}
  100%{opacity:1;transform:scale(1)}
}

header{text-align:center;padding:30px}
header img{max-width:420px;filter:drop-shadow(0 0 30px rgba(255,0,0,.9))}

.container{max-width:1200px;margin:auto;padding:20px}

.card{
  background:rgba(15,0,0,.55);
  border:1px solid rgba(255,0,0,.45);
  border-radius:16px;
  padding:26px;
  margin-bottom:26px;
}

.section-title{
  font-size:22px;
  color:#ff6a6a;
  margin-bottom:18px;
}

button,input{
  background:#0b0000;
  color:#ffd0d0;
  border:1px solid #aa2222;
  padding:8px 14px;
  font-family:'Cinzel',serif;
  cursor:pointer;
}

button:hover{box-shadow:0 0 15px rgba(255,0,0,.7)}
button.active{animation:pulse 1.4s infinite}

@keyframes pulse{
  0%{box-shadow:0 0 10px red}
  50%{box-shadow:0 0 25px red}
  100%{box-shadow:0 0 10px red}
}

#charHero{text-align:center}
#vocationIcon{width:160px}
#charNameBig{font-size:40px;color:#ff4a4a}
#charStats{font-size:22px;margin-top:6px}

#expValue{
  font-size:38px;
  color:#ff4a4a;
  text-align:center;
  margin-top:16px;
}

/* ===== SPEED ===== */
#speedBox{text-align:center}
#speedPercent{
  font-size:56px;
  color:#ff4a4a;
  margin:10px 0;
}
.speedBtns button{
  margin:4px;
  min-width:60px;
}
#speedTimer{
  font-size:28px;
  margin-top:10px;
  color:#ffd0d0;
}

footer{
  text-align:right;
  padding:10px 20px;
  font-size:12px;
  color:#aa5555;
}
</style>
</head>

<body>

<div id="clockBox">
  <div id="clockTime"></div>
  <div id="clockDate"></div>
</div>

<div id="intro">
  <img src="/static/intro/logo.png">
</div>

<header>
  <img src="/static/header/apo-tracker.png">
</header>

<div class="container">

<!-- POSTAĆ -->
<div class="card">
  <div class="section-title">Postać</div>
  Nick:
  <input id="charInput">
  <button onclick="setChar()">Ustaw</button>

  <div id="charHero">
    <img id="vocationIcon">
    <div id="charNameBig">—</div>
    <div id="charStats">—</div>
  </div>
</div>

<!-- EXP -->
<div class="card">
  <div class="section-title">Doświadczenie</div>
  <button onclick="refresh()">Odśwież</button>
  <div id="expValue">—</div>
</div>

<!-- SPEED -->
<div class="card">
  <div class="section-title">Speed (ETAP 1)</div>

  <div id="speedBox">
    <div id="speedPercent">50%</div>

    <div class="speedBtns">
      <script>
        for(let i=5;i<=50;i+=5)
          document.write(`<button onclick="setSpeed(${i})">${i}%</button>`);
      </script>
    </div>

    <div style="margin-top:10px">
      <label><input type="radio" name="speedTime" value="80" checked> 80 min</label>
      <label style="margin-left:20px">
        <input type="radio" name="speedTime" value="60"> 60 min
      </label>
    </div>

    <div style="margin-top:15px">
      <button id="speedStartBtn" onclick="startSpeed()">UŻYJ SPEEDA</button>
    </div>

    <div id="speedTimer">—</div>
  </div>
</div>

</div>

<footer>
  designed by Zohanek © <span id="year"></span>
</footer>

<script>
/* ===== INTRO / CLOCK ===== */
window.addEventListener("load",()=>setTimeout(()=>intro.style.display="none",2600));
setInterval(()=>{
  const n=new Date();
  clockTime.innerText=n.toLocaleTimeString();
  clockDate.innerText=n.toLocaleDateString();
},1000);
year.innerText=new Date().getFullYear();

/* ===== STATE ===== */
let char=localStorage.getItem("char")||"";
charInput.value=char;

let speedSettings=JSON.parse(localStorage.getItem("speedSettings")||"{}");
let speedInterval=null;

/* ===== PROFESSION FIX ===== */
function parseVocation(raw){
  if(raw===null||raw===undefined) return {icon:"rook.png",name:"Rook"};
  let c=String(raw).toLowerCase();

  if(c==="1") return {icon:"sorcerer.png",name:"Czarodziej"};
  if(c==="2") return {icon:"druid.png",name:"Druid"};
  if(c==="3") return {icon:"paladin.png",name:"Paladyn"};
  if(c==="4") return {icon:"knight.png",name:"Rycerz"};

  c=c.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z]/g,"");

  if(c.includes("knight")||c.includes("ek")) return {icon:"knight.png",name:"Rycerz"};
  if(c.includes("paladin")||c.includes("rp")) return {icon:"paladin.png",name:"Paladyn"};
  if(c.includes("druid")||c.includes("ed")) return {icon:"druid.png",name:"Druid"};
  if(c.includes("sorc")||c.includes("ms")) return {icon:"sorcerer.png",name:"Czarodziej"};

  return {icon:"rook.png",name:"Rook"};
}

/* ===== API ===== */
async function fetchPlayer(){
  const r=await fetch(`/player/${char}`);
  return r.json();
}

/* ===== CHAR ===== */
function setChar(){
  char=charInput.value.trim();
  localStorage.setItem("char",char);
  refresh();
}

async function refresh(){
  if(!char) return;
  const d=await fetchPlayer();
  const v=parseVocation(d.vocation);
  vocationIcon.src="/static/icons/"+v.icon;
  charNameBig.innerText=d.name;
  charStats.innerText=`${v.name} | Level ${d.level}`;
  expValue.innerText=d.experience.toLocaleString();
}

/* ===== SPEED ETAP 1 ===== */
let speedPercent=50;
let speedDuration=80;

function setSpeed(p){
  speedPercent=p;
  speedPercentDiv.innerText=p+"%";
  saveSpeed();
}
const speedPercentDiv=document.getElementById("speedPercent");

document.querySelectorAll('input[name="speedTime"]').forEach(r=>{
  r.addEventListener("change",()=>{
    speedDuration=Number(r.value);
    saveSpeed();
  });
});

function saveSpeed(){
  localStorage.setItem("speedSettings",JSON.stringify({
    percent:speedPercent,
    duration:speedDuration,
    startTime:speedSettings.startTime||null
  }));
}

function startSpeed(){
  speedSettings={
    percent:speedPercent,
    duration:speedDuration,
    startTime:Date.now()
  };
  localStorage.setItem("speedSettings",JSON.stringify(speedSettings));
  runTimer();
}

function runTimer(){
  if(speedInterval) clearInterval(speedInterval);
  speedInterval=setInterval(()=>{
    const elapsed=Math.floor((Date.now()-speedSettings.startTime)/1000);
    const left=speedSettings.duration*60-elapsed;
    if(left<=0){
      speedTimer.innerText="SPEED ZAKOŃCZONY";
      clearInterval(speedInterval);
      return;
    }
    const m=String(Math.floor(left/60)).padStart(2,"0");
    const s=String(left%60).padStart(2,"0");
    speedTimer.innerText=`Pozostało: ${m}:${s}`;
  },1000);
}

/* ===== INIT ===== */
if(speedSettings.percent){
  speedPercent=speedSettings.percent;
  speedDuration=speedSettings.duration;
  speedPercentDiv.innerText=speedPercent+"%";
  if(speedSettings.startTime) runTimer();
}
if(char) refresh();
</script>

</body>
</html>
