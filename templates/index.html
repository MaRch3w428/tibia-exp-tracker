<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f3caca;
  background:
    linear-gradient(rgba(0,0,0,.82), rgba(0,0,0,.95)),
    url("/static/bg.jpg") center/cover no-repeat fixed;
}

/* ===== INTRO ===== */
#intro{
  position:fixed;
  inset:0;
  background:
    linear-gradient(rgba(0,0,0,.6), rgba(0,0,0,.85)),
    url("/static/bg.jpg") center/cover no-repeat;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#intro img{
  width:480px;
  max-width:90%;
  opacity:0;
  transform:scale(.85);
  animation:introIn 1.8s forwards;
  filter:drop-shadow(0 0 0 red);
}
@keyframes introIn{
  0%{opacity:0;transform:scale(.85);filter:drop-shadow(0 0 0 red)}
  60%{opacity:1;transform:scale(1.05);filter:drop-shadow(0 0 40px red)}
  100%{opacity:1;transform:scale(1);filter:drop-shadow(0 0 60px red)}
}

/* ===== HEADER ===== */
header{text-align:center;padding:30px}
header img{max-width:420px;filter:drop-shadow(0 0 30px rgba(255,0,0,.9))}

.container{max-width:1200px;margin:auto;padding:20px}

/* ===== CARDS ===== */
.card{
  background:rgba(15,0,0,.55);
  border:1px solid rgba(255,0,0,.45);
  border-radius:16px;
  padding:26px;
  margin-bottom:26px;
}
.section-title{font-size:22px;color:#ff6a6a;margin-bottom:18px}

/* ===== INPUTS & BUTTONS ===== */
button,input{
  background:#0b0000;
  color:#ffd0d0;
  border:1px solid #aa2222;
  padding:8px 14px;
  font-family:'Cinzel',serif;
  cursor:pointer;
}
button:hover{box-shadow:0 0 15px rgba(255,0,0,.7)}
button.active{
  animation:pulse 1.4s infinite;
}
@keyframes pulse{
  0%{box-shadow:0 0 10px red}
  50%{box-shadow:0 0 25px red}
  100%{box-shadow:0 0 10px red}
}

/* ===== HERO ===== */
#charHero{text-align:center}
#vocationIcon{width:160px}
#charNameBig{font-size:40px;color:#ff4a4a}
#charStats{font-size:22px;margin-top:6px}

/* ===== EXP ===== */
#expValue{
  font-size:38px;
  color:#ff4a4a;
  text-align:center;
  margin-top:16px;
}

/* ===== TABLE ===== */
.list-header{
  display:grid;
  grid-template-columns:120px 120px 120px 120px 90px 180px 60px;
  gap:10px;
  font-size:14px;
  font-weight:bold;
  border-bottom:1px solid rgba(255,255,255,.2);
  padding-bottom:6px;
}
.list-row{
  display:grid;
  grid-template-columns:120px 120px 120px 120px 90px 180px 60px;
  gap:10px;
  font-size:17px;
  padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,.1);
}
.list-row div:nth-child(2),
.list-row div:nth-child(3){
  color:#ff6a6a;
}

/* ===== FOOTER ===== */
footer{
  text-align:right;
  padding:10px 20px;
  font-size:12px;
  color:#aa5555;
}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro">
  <img id="introLogo" src="/static/intro/logo.png">
</div>

<header>
  <img src="/static/header/apo-tracker.png">
</header>

<div class="container">

<!-- POSTAĆ -->
<div class="card">
  <div class="section-title">Postać</div>
  Nick:
  <input id="charInput" placeholder="Wpisz nick">
  <button id="setCharBtn" onclick="setChar()">Ustaw</button>

  <div id="charHero">
    <img id="vocationIcon">
    <div id="charNameBig">—</div>
    <div id="charStats">—</div>
  </div>
</div>

<!-- DOŚWIADCZENIE -->
<div class="card">
  <div class="section-title">DOŚWIADCZENIE</div>
  <button id="refreshBtn" onclick="refresh()">Odśwież</button>
  <label style="margin-left:12px">
    <input type="checkbox" id="autoRefreshChk"> Auto-refresh (10 min)
  </label>
  <div id="expValue">—</div>
</div>

<!-- SPEED -->
<div class="card">
  <div class="section-title">Speed</div>
  <button id="speedStartBtn" onclick="startSpeed()">START</button>
  <button id="speedStopBtn" onclick="stopSpeed()">STOP</button>
  <div id="speedStatus">—</div>
</div>

<!-- STATYSTYKA DZIENNA -->
<div class="card">
  <div class="section-title">STATYSTYKA DZIENNA</div>
  <button id="dayStartBtn" onclick="startDay()">START DNIA</button>
  <button id="dayEndBtn" onclick="endDay()">ZAKOŃCZ DZIEŃ</button>
  <div id="dayStatus">—</div>

  <div class="list-header">
    <div>Data</div>
    <div>EXP</div>
    <div>Speed</div>
    <div>Normal</div>
    <div>% Speed</div>
    <div>Lvle</div>
    <div>Usuń</div>
  </div>
  <div id="dayList"></div>
</div>

<!-- WYKRES -->
<div class="card">
  <div class="section-title">Wykres EXP</div>
  <canvas id="chart" height="120"></canvas>
</div>

</div>

<footer>
  designed by Zohanek © <span id="year"></span>
</footer>

<script>
/* ===== INTRO HIDE ===== */
window.addEventListener("load",()=>{
  setTimeout(()=>{
    const intro=document.getElementById("intro");
    intro.style.transition="opacity 1.2s ease";
    intro.style.opacity="0";
    setTimeout(()=>intro.style.display="none",1200);
  },2600);
});

/* ===== YEAR ===== */
year.innerText=new Date().getFullYear();

/* ===== STATE ===== */
let char=localStorage.getItem("char")||"";
charInput.value=char;

let autoRefresh=localStorage.getItem("autoRefresh")==="true";
autoRefreshChk.checked=autoRefresh;
let autoTimer=null;

let days=JSON.parse(localStorage.getItem("daysAuto")||"[]");
let currentDay=JSON.parse(localStorage.getItem("currentDay")||"null");
let speedStartExp=0;
let chart=null;

/* ===== ICON MAP ===== */
function iconFor(v){
  if(!v) return {icon:"rook.png",name:"Rook"};
  const s=v.toLowerCase();
  if(s.includes("rycerz")||s.includes("knight")) return {icon:"knight.png",name:"Rycerz"};
  if(s.includes("druid")) return {icon:"druid.png",name:"Druid"};
  if(s.includes("palad")) return {icon:"paladin.png",name:"Paladyn"};
  if(s.includes("czaro")) return {icon:"sorcerer.png",name:"Czarodziej"};
  return {icon:"rook.png",name:"Rook"};
}

/* ===== API ===== */
async function fetchPlayer(){
  const r=await fetch(`/player/${char}`);
  return r.json();
}

/* ===== CHAR ===== */
function setChar(){
  char=charInput.value.trim();
  localStorage.setItem("char",char);
  setCharBtn.classList.add("active");
  refresh();
  setTimeout(()=>setCharBtn.classList.remove("active"),600);
}
charInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") setChar();
});

/* ===== REFRESH ===== */
async function refresh(){
  if(!char) return;
  refreshBtn.classList.add("active");
  const d=await fetchPlayer();
  const voc=iconFor(d.vocation);
  vocationIcon.src="/static/icons/"+voc.icon;
  charNameBig.innerText=d.name;
  charStats.innerText=`${voc.name} | Level ${d.level} | Magic ${d.magic}`;
  expValue.innerText=d.experience.toLocaleString();
  setTimeout(()=>refreshBtn.classList.remove("active"),600);
}

/* ===== AUTO REFRESH ===== */
autoRefreshChk.addEventListener("change",()=>{
  autoRefresh=autoRefreshChk.checked;
  localStorage.setItem("autoRefresh",autoRefresh);
  if(autoRefresh) startAuto(); else stopAuto();
});
function startAuto(){
  stopAuto();
  autoTimer=setInterval(refresh,600000);
}
function stopAuto(){
  if(autoTimer) clearInterval(autoTimer);
}
if(autoRefresh) startAuto();

/* ===== SPEED ===== */
async function startSpeed(){
  const d=await fetchPlayer();
  speedStartExp=d.experience;
  speedStartBtn.classList.add("active");
  speedStatus.innerText="Speed aktywny";
}
async function stopSpeed(){
  const d=await fetchPlayer();
  if(currentDay) currentDay.speedExp+=d.experience-speedStartExp;
  speedStartBtn.classList.remove("active");
  speedStatus.innerText="Speed zatrzymany";
}

/* ===== DAY ===== */
async function startDay(){
  const d=await fetchPlayer();
  currentDay={
    date:new Date().toLocaleDateString(),
    expStart:d.experience,
    speedExp:0,
    lvlFrom:d.level
  };
  localStorage.setItem("currentDay",JSON.stringify(currentDay));
  dayStartBtn.classList.add("active");
  dayStatus.innerText="Dzień aktywny";
}
async function endDay(){
  if(!currentDay) return;
  const d=await fetchPlayer();
  const total=d.experience-currentDay.expStart;
  days.push({
    date:currentDay.date,
    exp:total,
    speedExp:currentDay.speedExp,
    normalExp:total-currentDay.speedExp,
    pct:total?Math.round(currentDay.speedExp/total*100):0,
    lvls:`${currentDay.lvlFrom} → ${d.level}`
  });
  localStorage.removeItem("currentDay");
  currentDay=null;
  localStorage.setItem("daysAuto",JSON.stringify(days));
  dayStartBtn.classList.remove("active");
  dayStatus.innerText="Dzień zakończony";
  renderDays();
}

/* ===== RENDER ===== */
function renderDays(){
  dayList.innerHTML="";
  days.forEach((d,i)=>{
    dayList.innerHTML+=`
      <div class="list-row">
        <div>${d.date}</div>
        <div>${d.exp.toLocaleString()}</div>
        <div>${d.speedExp.toLocaleString()}</div>
        <div>${d.normalExp.toLocaleString()}</div>
        <div>${d.pct}%</div>
        <div>${d.lvls}</div>
        <div><button onclick="delDay(${i})">X</button></div>
      </div>`;
  });
  renderChart();
}
function delDay(i){
  days.splice(i,1);
  localStorage.setItem("daysAuto",JSON.stringify(days));
  renderDays();
}

/* ===== CHART ===== */
function renderChart(){
  const ctx=document.getElementById("chart");
  if(chart) chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:days.map(d=>d.date),
      datasets:[{
        data:days.map(d=>d.exp),
        borderColor:"#ff4a4a",
        tension:.3
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{title:{display:true,text:"Data"}},
        y:{title:{display:true,text:"EXP"}}
      }
    }
  });
}

/* INIT */
if(currentDay){
  dayStartBtn.classList.add("active");
  dayStatus.innerText="Dzień aktywny (wznawiany)";
}
if(char) refresh();
renderDays();
</script>

</body>
</html>
