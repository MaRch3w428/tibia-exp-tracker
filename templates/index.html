<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: 'Cinzel', serif;
  background:
    linear-gradient(rgba(0,0,0,0.75), rgba(0,0,0,0.85)),
    url("/static/bg.jpg") center / cover no-repeat fixed;
  color: #e6d8a8;
}

.hero {
  text-align: center;
  padding: 60px 20px 40px;
}

.hero h1 {
  font-size: 48px;
  letter-spacing: 3px;
  color: #d4af37;
  text-shadow: 0 0 10px rgba(212,175,55,0.6), 2px 2px 4px #000;
  margin: 0;
}

.hero h2 {
  margin-top: 10px;
  font-size: 16px;
  letter-spacing: 2px;
  color: #aaa;
  text-shadow: 1px 1px 2px #000;
}

.container {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}

.box {
  background: rgba(20,20,20,0.88);
  border: 1px solid #c9a14a;
  box-shadow: 0 0 12px rgba(201,161,74,0.25);
  border-radius: 6px;
  padding: 14px;
  margin-top: 16px;
}

.section-title {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 18px;
  margin-bottom: 8px;
  color: #d4af37;
}

.section-title img {
  width: 24px;
  height: 24px;
  image-rendering: pixelated;
}

button, input {
  background: #1a1a1a;
  color: #e6d8a8;
  border: 1px solid #c9a14a;
  padding: 8px 12px;
  font-family: 'Cinzel', serif;
}

button {
  cursor: pointer;
}

button:hover {
  background: #2a2a2a;
}

.exp-bar {
  height: 14px;
  background: #2a2a2a;
  border: 1px solid #000;
  margin-top: 8px;
}

#expFill {
  height: 100%;
  width: 0%;
  background: linear-gradient(to right, #c9a14a, #ffe082);
  box-shadow: inset 0 0 5px #000;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  border: 1px solid #333;
  padding: 6px;
  text-align: center;
}

th {
  background: #1f1f1f;
  color: #d4af37;
}

canvas {
  background: #111;
  margin-top: 20px;
  border-radius: 6px;
}
</style>
</head>

<body>

<div class="hero">
  <h1>APO Podkarpacki OTS Tracker</h1>
  <h2>by Zohanek</h2>
</div>

<div class="container">

<div id="appStatus" class="box">‚è≥ Uruchamianie aplikacji‚Ä¶</div>

<div class="box">
  <div class="section-title">
    <img src="/static/icons/mage.png">
    Postaƒá
  </div>
  Nick:
  <input id="charName" placeholder="np. Zohanek">
  <button id="setCharBtn">Ustaw</button>
  <div id="charInfo">‚Äî</div>
</div>

<div class="box">
  <div class="section-title">
    <img src="/static/icons/star.png">
    EXP
  </div>
  <button id="refreshBtn">Od≈õwie≈º EXP</button>
  <div id="expStatus">‚Äî</div>
  <div class="exp-bar">
    <div id="expFill"></div>
  </div>
</div>

<div class="box">
  <div class="section-title">
    <img src="/static/icons/lightning.png">
    Speed
  </div>
  <button id="startSpeedBtn">START SPEED</button>
  <button id="stopSpeedBtn">STOP SPEED</button>
  <div id="speedStatus">Speed nieaktywny</div>
</div>

<div class="box">
  <div class="section-title">
    <img src="/static/icons/scroll.png">
    Dzie≈Ñ & Historia
  </div>
  <button id="startDayBtn">START DNIA</button>
  <button id="endDayBtn">ZAKO≈ÉCZ DZIE≈É</button>
  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>EXP</th>
        <th>Speed</th>
        <th>Normal</th>
      </tr>
    </thead>
    <tbody id="history"></tbody>
  </table>
</div>

<canvas id="expChart"></canvas>

</div>

<script>
let characterName = localStorage.getItem("tibiaChar") || "";
document.getElementById("charName").value = characterName;

let isFetching = false;
let lastFetchedExp = null;

let speedStartExp = null;
let speedStartTime = null;

let dayStartExp = null;
let daySpeedExp = 0;

let history = JSON.parse(localStorage.getItem("tibiaHistory")) || [];
let chart = null;

async function fetchPlayer() {
  const res = await fetch(`/player/${characterName}`);
  return await res.json();
}

async function refreshExp() {
  if (isFetching || !characterName) return;
  isFetching = true;

  document.getElementById("appStatus").innerText =
    "‚è≥ ≈ÅƒÖczenie z serwerem‚Ä¶";

  try {
    const data = await fetchPlayer();
    lastFetchedExp = data.experience;

    document.getElementById("charInfo").innerText =
      `${data.name} | Level ${data.level} | ML ${data.magic}`;

    document.getElementById("expStatus").innerText =
      data.experience.toLocaleString();

    document.getElementById("expFill").style.width =
      Math.min(100, (data.experience % 10000000) / 100000) + "%";

    document.getElementById("appStatus").innerText =
      "üü¢ Po≈ÇƒÖczono z serwerem";
  } catch {
    document.getElementById("appStatus").innerText =
      "üî¥ Serwer siƒô budzi‚Ä¶ spr√≥buj za chwilƒô";
  } finally {
    isFetching = false;
  }
}

document.getElementById("setCharBtn").onclick = () => {
  characterName = document.getElementById("charName").value.trim();
  localStorage.setItem("tibiaChar", characterName);
  refreshExp();
};

document.getElementById("refreshBtn").onclick = refreshExp;

setInterval(() => {
  if (!document.hidden && characterName) refreshExp();
}, 120000);

if (characterName) refreshExp();
</script>

</body>
</html>
