<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#e6d8a8;
  background:
    linear-gradient(rgba(0,0,0,.65), rgba(0,0,0,.85)),
    url("/static/bg.jpg") center / cover no-repeat fixed;
  min-height:100vh;
}

/* ===== INTRO ===== */
#intro{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  z-index:999;
  animation:introFade 4.5s forwards;
}
.intro-bg{
  position:absolute;
  inset:0;
  background:
    radial-gradient(circle at center, rgba(212,175,55,.25), rgba(0,0,0,.9)),
    url("/static/bg.jpg") center/cover no-repeat;
  filter:blur(6px) brightness(.6);
  animation:bgZoom 6s forwards;
}
#intro h1{
  position:relative;
  font-family:'Cinzel Decorative',serif;
  font-size:72px;
  letter-spacing:8px;
  color:#d4af37;
  text-shadow:0 0 40px rgba(212,175,55,.9);
  animation:titleIn 2s forwards;
}
#intro span{
  position:relative;
  margin-top:10px;
  letter-spacing:4px;
  color:#aaa;
  opacity:0;
  animation:subIn 2s 1.2s forwards;
}
@keyframes titleIn{from{opacity:0;transform:scale(.6)}to{opacity:1}}
@keyframes subIn{to{opacity:1}}
@keyframes bgZoom{to{transform:scale(1.15)}}
@keyframes introFade{0%,80%{opacity:1}100%{opacity:0;visibility:hidden}}

/* ===== HEADER ===== */
header{
  text-align:center;
  padding:60px 20px 30px;
}
header h1{
  font-family:'Cinzel Decorative',serif;
  font-size:48px;
  color:#d4af37;
  text-shadow:0 0 18px rgba(212,175,55,.7);
}

/* ===== CLOCK ===== */
#clock{
  position:fixed;
  top:20px;
  right:20px;
  text-align:right;
  font-size:18px;
  color:#d4af37;
  text-shadow:0 0 10px rgba(212,175,55,.6);
  animation:clockGlow 3s infinite;
}
@keyframes clockGlow{0%,100%{opacity:.7}50%{opacity:1}}

/* ===== LAYOUT ===== */
.container{
  max-width:1100px;
  margin:auto;
  padding:20px;
}

/* ===== CARDS ===== */
.card{
  background:linear-gradient(180deg, rgba(25,25,25,.95), rgba(10,10,10,.95));
  border:1px solid #c9a14a;
  border-radius:10px;
  padding:18px;
  margin-bottom:22px;
  box-shadow:0 0 25px rgba(201,161,74,.25), inset 0 0 20px rgba(0,0,0,.8);
  animation:cardIn .6s ease;
  transition:.25s;
}
.card:hover{
  transform:translateY(-4px);
  box-shadow:0 0 35px rgba(212,175,55,.35), inset 0 0 20px rgba(0,0,0,.8);
}
@keyframes cardIn{from{opacity:0;transform:translateY(20px)}to{opacity:1}}

.section-title{
  font-size:20px;
  color:#d4af37;
  margin-bottom:12px;
}

input,button{
  background:#0f0f0f;
  color:#e6d8a8;
  border:1px solid #c9a14a;
  padding:8px 14px;
  font-family:'Cinzel',serif;
}
button:hover{
  background:#222;
  box-shadow:0 0 12px rgba(212,175,55,.4);
}
button{cursor:pointer}

#charInfo,#expInfo{
  font-size:22px;
  margin-top:10px;
  line-height:1.4;
  text-shadow:0 0 8px rgba(212,175,55,.4);
}
#expInfo span{
  font-size:28px;
  animation:breathe 2.5s infinite;
}
@keyframes breathe{0%,100%{text-shadow:0 0 8px rgba(212,175,55,.4)}50%{text-shadow:0 0 18px rgba(212,175,55,.9)}}

.active-speed{
  animation:speedPulse 1.6s infinite;
}
@keyframes speedPulse{
  0%{box-shadow:0 0 15px rgba(212,175,55,.3)}
  50%{box-shadow:0 0 35px rgba(212,175,55,.9)}
  100%{box-shadow:0 0 15px rgba(212,175,55,.3)}
}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #333;padding:6px;text-align:center}
th{background:#1b1b1b;color:#d4af37}

canvas{background:#0b0b0b;border-radius:8px;padding:10px}

footer{
  position:fixed;
  bottom:12px;
  right:18px;
  font-size:12px;
  color:#888;
}
</style>
</head>

<body>

<div id="intro">
  <div class="intro-bg"></div>
  <h1>APO PODKARPACKI</h1>
  <span>OTS TRACKER</span>
</div>

<div id="clock"></div>

<header>
  <h1>APO Podkarpacki OTS Tracker</h1>
</header>

<div class="container">

<div class="card">
  <div class="section-title">Postaƒá</div>
  Nick: <input id="charName">
  <button onclick="setChar()">Ustaw</button>
  <div id="charInfo">‚Äî</div>
</div>

<div class="card">
  <div class="section-title">EXP</div>
  <button onclick="refreshExp()">Od≈õwie≈º</button>
  <label><input type="checkbox" id="autoToggle"> Auto-refresh co 10 min</label>
  <div id="expInfo">‚Äî</div>
  <div id="status"></div>
</div>

<div class="card" id="speedCard">
  <div class="section-title">Speed</div>
  <button id="startSpeedBtn" onclick="startSpeed()">START</button>
  <button id="stopSpeedBtn" onclick="stopSpeed()" disabled>STOP</button>
  <div id="speedInfo">‚Äî</div>
</div>

<div class="card">
  <div class="section-title">Ranking Speed√≥w</div>
  <table id="speedTable"><thead><tr><th>#</th><th>Godzina</th><th>EXP</th><th>EXP/min</th></tr></thead><tbody></tbody></table>
</div>

<div class="card">
  <div class="section-title">Dzie≈Ñ</div>
  <button onclick="startDay()">START DNIA</button>
  <button onclick="endDay()">ZAKO≈ÉCZ</button>
</div>

<div class="card">
  <div class="section-title">Historia dni</div>
  <table id="daysTable"><thead><tr><th>Data</th><th>EXP</th><th></th></tr></thead><tbody></tbody></table>
</div>

<div class="card">
  <div class="section-title">Wykres EXP</div>
  <canvas id="expChart" height="120"></canvas>
</div>

</div>

<footer>designed by Zohanek ¬© <span id="year"></span></footer>

<script>
document.getElementById("year").innerText=new Date().getFullYear();

function updateClock(){
  const d=new Date();
  clock.innerHTML=d.toLocaleDateString()+"<br>"+d.toLocaleTimeString();
}
setInterval(updateClock,1000);updateClock();

let char=localStorage.getItem("char")||"";
charName.value=char;

let history=JSON.parse(localStorage.getItem("expHistory"))||[];
let speedHistory=JSON.parse(localStorage.getItem("speedHistory"))||[];
let chart=null,dayStart=null,dayDate=null,speedStart=null,speedTime=null;

async function fetchPlayer(){
  const r=await fetch(`/player/${char}`);
  return r.json();
}

function setChar(){
  char=charName.value.trim();
  localStorage.setItem("char",char);
  refreshExp();
}

async function refreshExp(){
  if(!char)return;
  status.innerText="‚è≥";
  try{
    const d=await fetchPlayer();
    charInfo.innerHTML=`üßô ${d.name}<br>üõ° Poziom: <b>${d.level}</b><br>üîÆ Magic: <b>${d.magic}</b>`;
    expInfo.innerHTML=`‚≠ê EXP:<br><span>${d.experience.toLocaleString()}</span>`;
    status.innerText="üü¢ ONLINE";
  }catch{status.innerText="üî¥ OFFLINE";}
}

async function startSpeed(){
  const d=await fetchPlayer();
  speedStart=d.experience;
  speedTime=Date.now();
  speedCard.classList.add("active-speed");
  startSpeedBtn.disabled=true;
  stopSpeedBtn.disabled=false;
}

async function stopSpeed(){
  const d=await fetchPlayer();
  const min=(Date.now()-speedTime)/60000;
  const gain=d.experience-speedStart;
  const epm=Math.round(gain/min);
  speedHistory.push({t:new Date().toLocaleTimeString(),e:gain,epm});
  localStorage.setItem("speedHistory",JSON.stringify(speedHistory));
  speedInfo.innerText=`${Math.round(min)} min | +${gain} | ${epm} EXP/min`;
  speedCard.classList.remove("active-speed");
  startSpeedBtn.disabled=false;
  stopSpeedBtn.disabled=true;
  renderSpeedRanking();
}

function renderSpeedRanking(){
  const tbody=speedTable.querySelector("tbody");
  tbody.innerHTML="";
  [...speedHistory].sort((a,b)=>b.epm-a.epm).slice(0,10).forEach((s,i)=>{
    tbody.innerHTML+=`<tr><td>${i+1}</td><td>${s.t}</td><td>+${s.e}</td><td><b>${s.epm}</b></td></tr>`;
  });
}

async function startDay(){
  const d=await fetchPlayer();
  dayStart=d.experience;
  dayDate=new Date().toLocaleDateString();
}

async function endDay(){
  const d=await fetchPlayer();
  const gain=d.experience-dayStart;
  history.push({t:dayDate,e:gain});
  localStorage.setItem("expHistory",JSON.stringify(history));
  renderDays();updateChart();
}

function renderDays(){
  const tbody=daysTable.querySelector("tbody");
  tbody.innerHTML="";
  history.forEach((d,i)=>{
    tbody.innerHTML+=`<tr><td>${d.t}</td><td>+${d.e}</td><td><button onclick="delDay(${i})">üóë</button></td></tr>`;
  });
}
function delDay(i){
  history.splice(i,1);
  localStorage.setItem("expHistory",JSON.stringify(history));
  renderDays();updateChart();
}

function updateChart(){
  const labels=history.map(h=>h.t);
  const data=history.map(h=>h.e);
  if(!chart){
    chart=new Chart(expChart,{type:"line",data:{labels,datasets:[{data,borderColor:"#d4af37",fill:true,backgroundColor:"rgba(212,175,55,.2)"}]},options:{plugins:{legend:{display:false}}}});
  }else{
    chart.data.labels=labels;
    chart.data.datasets[0].data=data;
    chart.update();
  }
}

let auto=localStorage.getItem("autoRefresh")==="true";
autoToggle.checked=auto;
let autoInt=null;
function startAuto(){autoInt=setInterval(()=>char&&refreshExp(),600000)}
function stopAuto(){clearInterval(autoInt)}
autoToggle.onchange=()=>{auto=autoToggle.checked;localStorage.setItem("autoRefresh",auto);auto?startAuto():stopAuto()}
if(auto)startAuto();

renderDays();renderSpeedRanking();updateChart();
if(char)refreshExp();
</script>

</body>
</html>
