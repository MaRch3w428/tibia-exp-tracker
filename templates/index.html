<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO EXP Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}

body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f2caca;
  background:
    linear-gradient(rgba(0,0,0,.85), rgba(0,0,0,.95)),
    url("/static/bg.jpg") center/cover no-repeat fixed;
}

/* ===== INTRO ===== */
#intro{
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  animation:introFade 3s forwards;
}
#intro h1{
  font-family:'Cinzel Decorative',serif;
  font-size:64px;
  color:#ff3b3b;
  text-shadow:0 0 30px rgba(255,0,0,.9);
  animation:introText 3s forwards;
}
@keyframes introFade{0%,80%{opacity:1}100%{opacity:0;visibility:hidden}}
@keyframes introText{0%{opacity:0;transform:scale(.7)}40%{opacity:1}100%{transform:scale(1.05)}}

/* ===== CLOCK ===== */
#clock{
  position:fixed;
  top:20px;
  right:25px;
  text-align:right;
  font-size:22px;
  color:#ff4a4a;
}
#clock span{display:block;font-size:14px;color:#ffaaaa}

/* ===== HEADER ===== */
header{
  text-align:center;
  padding:30px 20px;
}
header img{
  max-width:420px;
  filter:drop-shadow(0 0 25px rgba(255,0,0,.8));
}

/* ===== LAYOUT ===== */
.container{
  max-width:900px;
  margin:auto;
  padding:20px;
}
.card{
  background:rgba(20,0,0,.7);
  border:1px solid rgba(255,0,0,.4);
  border-radius:14px;
  padding:22px;
  margin-bottom:22px;
}
h2{margin:0 0 15px;color:#ff6a6a}

/* ===== INPUTS ===== */
input,button{
  background:#0b0000;
  color:#ffd0d0;
  border:1px solid #aa2222;
  padding:8px 14px;
  font-family:'Cinzel',serif;
}
button{cursor:pointer}

/* ===== CHAR ===== */
#charBox{
  display:flex;
  align-items:center;
  gap:25px;
  margin-top:18px;
}
#vocationIcon{width:130px}
#charInfo{font-size:20px;line-height:1.5}

/* ===== EXP ===== */
#expBox{
  margin-top:25px;
  text-align:center;
}
#expValue{
  margin-top:20px;
  font-size:34px;
  font-weight:700;
  color:#ff4a4a;
  text-shadow:0 0 20px rgba(255,0,0,.8);
}

/* ===== SPEED / DAY ===== */
.infoVal{
  font-size:22px;
  margin-top:15px;
}

/* ===== FOOTER ===== */
footer{
  text-align:right;
  padding:10px 20px;
  font-size:12px;
  color:#aa5555;
}
</style>
</head>

<body>

<div id="intro">
  <h1>APO TRACKER</h1>
</div>

<div id="clock"></div>

<header>
  <img src="/static/header/apo-tracker.png" alt="APO Tracker">
</header>

<div class="container">

<div class="card">
  <h2>Postać</h2>
  Nick:
  <input id="charName">
  <button onclick="setChar()">Ustaw</button>

  <div id="charBox">
    <img id="vocationIcon" src="/static/icons/rook.png">
    <div id="charInfo">—</div>
  </div>
</div>

<div class="card">
  <h2>EXP</h2>
  <button onclick="refresh()">Odśwież</button>

  <div id="expBox">
    <div id="expValue">—</div>
  </div>
</div>

<div class="card">
  <h2>Speed</h2>
  <button onclick="startSpeed()">START</button>
  <button onclick="stopSpeed()">STOP</button>
  <div id="speedInfo" class="infoVal">—</div>
</div>

<div class="card">
  <h2>Dzień</h2>
  <button onclick="startDay()">START DNIA</button>
  <button onclick="endDay()">ZAKOŃCZ DZIEŃ</button>
  <div id="dayInfo" class="infoVal">—</div>
</div>

</div>

<footer>
  designed by Zohanek © <span id="year"></span>
</footer>

<script>
/* ===== CLOCK ===== */
function updateClock(){
  const d=new Date();
  clock.innerHTML=d.toLocaleTimeString()+"<span>"+d.toLocaleDateString()+"</span>";
}
setInterval(updateClock,1000);
updateClock();
year.innerText=new Date().getFullYear();

/* ===== STATE ===== */
let currentChar="";
let speedStartExp=0, speedStartTime=0;
let dayStartExp=0;

/* ===== ICON MAP (FIXED) ===== */
function iconFor(v){
  if(!v) return "rook.png";

  v = v.trim().toLowerCase();

  if(v === "druid") return "druid.png";
  if(v === "paladyn") return "paladin.png";
  if(v === "knight") return "knight.png";
  if(v === "czarodziej") return "sorcerer.png";

  return "rook.png";
}

/* ===== FETCH ===== */
async function fetchPlayer(){
  const r = await fetch(`/player/${currentChar}`);
  if(!r.ok) throw "API error";
  return r.json();
}

/* ===== ACTIONS ===== */
function setChar(){
  currentChar = charName.value.trim();
  refresh();
}

async function refresh(){
  if(!currentChar) return;

  const d = await fetchPlayer();

  vocationIcon.src="/static/icons/"+iconFor(d.vocation);
  charInfo.innerHTML=`<b>${d.name}</b><br>Level: ${d.level}<br>Magic: ${d.magic}<br>${d.vocation}`;
  expValue.innerText=d.experience.toLocaleString();
}

/* ===== SPEED ===== */
async function startSpeed(){
  const d=await fetchPlayer();
  speedStartExp=d.experience;
  speedStartTime=Date.now();
  speedInfo.innerText="Liczenie…";
}
async function stopSpeed(){
  const d=await fetchPlayer();
  const min=(Date.now()-speedStartTime)/60000;
  const gain=d.experience-speedStartExp;
  speedInfo.innerText=`+${gain.toLocaleString()} EXP | ${Math.round(gain/min)} EXP/min`;
}

/* ===== DAY ===== */
async function startDay(){
  const d=await fetchPlayer();
  dayStartExp=d.experience;
  dayInfo.innerText="Dzień rozpoczęty";
}
async function endDay(){
  const d=await fetchPlayer();
  const gain=d.experience-dayStartExp;
  dayInfo.innerText=`Dziś: +${gain.toLocaleString()} EXP`;
}
</script>

</body>
</html>
