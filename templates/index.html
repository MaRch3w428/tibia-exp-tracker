<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link rel="stylesheet" href="/static/css/style.css">
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f3caca;
  background:
    linear-gradient(rgba(0,0,0,.82), rgba(0,0,0,.95)),
    url("/static/bg.jpg") center/cover no-repeat fixed;
}

/* CLOCK */
#clockBox{
  position:fixed;
  top:20px;
  right:30px;
  text-align:right;
  z-index:20000; /* MUSI byƒá wy≈ºsze ni≈º intro */
  color:#ff6a6a;
  text-shadow:0 0 15px rgba(255,0,0,.7);
  pointer-events:none;
}
#clockTime{font-size:32px;font-weight:700}
#clockDate{font-size:16px;opacity:.85}


/* INTRO */
#intro{
  position:fixed;
  inset:0;
  background:black;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  overflow:hidden;
  transition:
    opacity 1.2s ease,
    filter 1.2s ease;
}

#intro.fade-out{
  opacity:0;
  filter:blur(8px);
  pointer-events:none;
}


/* VIDEO T≈ÅA */
#intro video{
  position:absolute;
  inset:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
  z-index:0;
}

/* LOGO ‚Äì BEZ ZMIAN W ANIMACJI */
#intro img{
  position:relative;
  z-index:2;
  width:480px;
  max-width:90%;
  opacity:0;
  transform:scale(.85);
  animation:introIn 1.8s forwards;
}

@keyframes introIn{
  0%{opacity:0;transform:scale(.85)}
  60%{opacity:1;transform:scale(1.05)}
  100%{opacity:1;transform:scale(1)}
}


header{text-align:center;padding:30px}
header img{
  max-width:560px;
  opacity:.85;
  filter:
    drop-shadow(0 0 40px rgba(255,0,0,.9))
    drop-shadow(0 0 80px rgba(255,0,0,.35));
}


.container{max-width:1200px;margin:auto;padding:20px}

.card{
  background:rgba(5,0,0,.82);
  border:1px solid rgba(255,0,0,.45);
  border-radius:16px;
  padding:26px;
  margin-bottom:26px;

  backdrop-filter: blur(6px);
  box-shadow:
    0 0 25px rgba(255,0,0,.12),
    inset 0 0 30px rgba(0,0,0,.4);

  transition:
    transform .25s ease,
    box-shadow .25s ease,
    border-color .25s ease;
}

  .card:hover{
  transform: translateY(-3px);
  border-color:#ff4a4a;
  box-shadow:
    0 0 40px rgba(255,0,0,.28),
    inset 0 0 30px rgba(0,0,0,.4);
}


.section-title{
  font-size:22px;
  color:#ff6a6a;
  margin-bottom:18px;
  letter-spacing:.08em;
  text-shadow:0 0 12px rgba(255,0,0,.45);
}

  .card::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:16px;
  pointer-events:none;
  box-shadow:inset 0 0 40px rgba(0,0,0,.6);
}
.card{ position:relative; }

button,input{
  background:#0b0000;
  color:#ffd0d0;
  border:1px solid #aa2222;
  padding:8px 14px;
  font-family:'Cinzel',serif;
  cursor:pointer;
}
button:hover{box-shadow:0 0 15px rgba(255,0,0,.7)}
button.active{box-shadow:0 0 25px red}

#charHero{text-align:center}
#vocationIcon{
  width:200px;
  margin-bottom:10px;
  filter:drop-shadow(0 0 20px rgba(255,0,0,.6));
}

#charNameBig{font-size:38px;color:#ff4a4a}
#charStats{font-size:20px;margin-top:6px}
#expValue{font-size:36px;color:#ff4a4a;margin-top:10px}

/* SPEED */
#speedBox{text-align:center}
#speedPercent{font-size:52px;color:#ff4a4a}
.speedBtns button{margin:4px;min-width:60px}
#speedTimer{font-size:26px;margin-top:10px}

/* LIST */
.list-header,.list-row{
  display:grid;
  grid-template-columns:120px 120px 120px 120px 90px 180px 60px;
  gap:10px;
}
.list-header{
  font-size:14px;
  font-weight:bold;
  border-bottom:1px solid rgba(255,255,255,.2);
}
.list-row{
  font-size:17px;
  padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,.1);
}

  /* === SUMMARY (pod wykresem) === */
#summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
  margin-top:20px;
}
.summaryBox{
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,0,0,.35);
  border-radius:14px;
  padding:16px;
  text-align:center;
}
.summaryVal{
  font-size:26px;
  color:#ff4a4a;
  margin-top:6px;
}

footer{text-align:right;padding:10px 20px;font-size:12px;color:#aa5555}

<style>
/* === CZYTELNOSC LICZB (KROK 2) === */
#expValue,
#speedPercent,
.summaryVal{
  color:#ffecec;
  text-shadow:0 0 6px rgba(255,80,80,.6);
}


</style>
</head>

<body>
  

  <!-- RESZTA STRONY (TW√ìJ TRACKER) -->


<div id="clockBox">
  <div id="clockTime"></div>
  <div id="clockDate"></div>
</div>

<div id="intro">
  <video autoplay muted playsinline loop preload="auto">
    <source src="/static/video/intro.mp4" type="video/mp4">
  </video>
  <img src="/static/intro/logo.png">
</div>

<header><img src="/static/header/apo-tracker.png"></header>

<div class="container">

<!-- PANEL POSTACI -->
<div class="card card-active">
  <div class="section-title">Postaƒá</div>
  Nick:
  <input id="charInput">
  <button onclick="setChar()">USTAW</button>

  <div id="charHero">
    <img id="vocationIcon">
    <div id="charNameBig">‚Äî</div>
    <div id="charStats">‚Äî</div>
    <div id="expValue">‚Äî</div>
  </div>

  <div style="margin-top:15px">
    <button onclick="refresh()">Od≈õwie≈º</button>
    <button id="autoBtn" onclick="toggleAuto()">Auto-od≈õwie≈º: WY≈Å</button>
  </div>
</div>

<!-- SPEED -->
<div class="card">
  <div class="section-title">Speed</div>

  <div id="speedBox">
    <div id="speedPercent">50%</div>
    <div class="speedBtns" id="speedBtns"></div>

    <div style="margin-top:10px">
      <label><input type="radio" name="speedTime" value="80"> 80 min</label>
      <label style="margin-left:20px">
        <input type="radio" name="speedTime" value="60"> 60 min</label>
    </div>

    <div style="margin-top:15px">
      <button onclick="startSpeed()">U≈ªYJ SPEEDA</button>
      <button onclick="resetSpeed()">RESTART SPEED</button>
    </div>

    <div id="speedTimer">‚Äî</div>
  </div>
</div>

<!-- STATYSTYKA DNIA -->
<div class="card">
  <div class="section-title">Statystyka dzienna</div>
  <button onclick="startDay()">START DNIA</button>
  <button onclick="endDay()">ZAKO≈ÉCZ DZIE≈É</button>
  <div id="dayStatus">‚Äî</div>

  <div class="list-header">
    <div>Data</div><div>EXP</div><div>Speed</div><div>Normal</div><div>%</div><div>Lvle</div><div>Usu≈Ñ</div>
  </div>
  <div id="dayList"></div>
</div>

<!-- WYKRES -->
<div class="card">
  <div class="section-title">Wykres EXP</div>
  <canvas id="chart" height="140"></canvas>
  <div id="summary">
  <div class="summaryBox">
    ≈ÅƒÖczny EXP
    <div class="summaryVal" id="sumExp">‚Äî</div>
  </div>
  <div class="summaryBox">
    ≈örednio / dzie≈Ñ
    <div class="summaryVal" id="avgExp">‚Äî</div>
  </div>
  <div class="summaryBox">
    Ilo≈õƒá dni
    <div class="summaryVal" id="daysCount">‚Äî</div>
  </div>
  <div class="summaryBox">
    % ze speeda
    <div class="summaryVal" id="speedPct">‚Äî</div>
  </div>
</div>

</div>

</div>

<footer>designed by Zohanek ¬© <span id="year"></span></footer>

<script>
/* CLOCK + INTRO */
const introEl = document.getElementById("intro");
if(introEl){
  setTimeout(()=>{
    introEl.classList.add("fade-out");

    setTimeout(()=>{
      introEl.remove();
    },1200); // czas fade (musi pasowaƒá do CSS)
  },5000); // d≈Çugo≈õƒá intro
}

year.innerText=new Date().getFullYear();

/* GLOBAL */
let char=localStorage.getItem("apo_last_char")||"";
charInput.value=char;
charInput.addEventListener("keydown",e=>{if(e.key==="Enter")setChar();});

/* HELPERS */
function key(k){return `apo_${char}_${k}`}

/* API */
async function fetchPlayer(){
  const r=await fetch(`/player/${char}`);
  return r.json();
}

/* PANEL POSTACI */
function setChar(){
  char=charInput.value.trim();
  localStorage.setItem("apo_last_char",char);
  refresh();
  loadState();
}

async function refresh(){
  if(!char) return;

  const d = await fetchPlayer();

  charNameBig.innerText = d.name;
  charStats.innerText = `${d.vocation} | Level ${d.level} | Magic ${d.magic}`;
  expValue.innerText = d.experience.toLocaleString();

  const v = d.vocation.toLowerCase();
  vocationIcon.src = "/static/icons/" + (
    v.includes("druid") ? "druid.png" :
    v.includes("paladyn") ? "paladin.png" :
    v.includes("czaro") ? "sorcerer.png" :
    v.includes("rycerz") ? "knight.png" : "rook.png"
  );

  // üî• TU LICZY SIƒò EXP
  trackExpTick(d.experience);
}



/* AUTO REFRESH */
let autoTimer=null;
function toggleAuto(){
  const on=localStorage.getItem(key("auto"))==="1";
  if(on){
    clearInterval(autoTimer);
    localStorage.setItem(key("auto"),"0");
    autoBtn.innerText="Auto-od≈õwie≈º: WY≈Å";
  }else{
    autoTimer=setInterval(refresh,600000);
    localStorage.setItem(key("auto"),"1");
    autoBtn.innerText="Auto-od≈õwie≈º: W≈Å";
  }
}
function initAuto(){
  if(localStorage.getItem(key("auto"))==="1"){
    toggleAuto();
  }
}

/* SPEED */
let speedPercent=50;
let speedDuration=80;
let speedStart=null;
let speedInterval=null;
let lastExpAtSpeedStart=0
let lastGlobalExp = 0;

  

function renderSpeedBtns(){
  speedBtns.innerHTML="";
  for(let i=5;i<=50;i+=5){
    const b=document.createElement("button");
    b.innerText=i+"%";
    if(i===speedPercent) b.classList.add("active");
    b.onclick=()=>{
      speedPercent=i;
      speedPercentEl.innerText=i+"%";
      saveSpeed();
      renderSpeedBtns();
    };
    speedBtns.appendChild(b);
  }
}
function saveSpeed(){
  localStorage.setItem(key("speed"),JSON.stringify({
    percent:speedPercent,
    duration:speedDuration,
    start:speedStart,
    lastExp:lastExpAtSpeedStart
  }));
}
function loadSpeed(){
  const s=JSON.parse(localStorage.getItem(key("speed"))||"{}");
  speedPercent=s.percent||50;
  speedDuration=s.duration||80;
  speedStart=s.start||null;
  lastExpAtSpeedStart=s.lastExp||0;

  speedPercentEl.innerText=speedPercent+"%";

  document.querySelectorAll('input[name="speedTime"]').forEach(r=>{
    r.checked=Number(r.value)===speedDuration;
    r.onchange=()=>{speedDuration=Number(r.value);saveSpeed();}
  });

  renderSpeedBtns();
  if(speedStart) runTimer();
}

async function startSpeed(){
  const d=await fetchPlayer();
  speedStart=Date.now();
  lastExpAtSpeedStart=d.experience;
  saveSpeed();
  runTimer();
}
function resetSpeed(){
  speedPercent=50;
  speedDuration=80;
  speedStart=null;
  lastExpAtSpeedStart=0;
  saveSpeed();
  speedTimer.innerText="‚Äî";
  speedPercentEl.innerText="50%";
  renderSpeedBtns();
}
function runTimer(){
  clearInterval(speedInterval);

  speedInterval = setInterval(() => {
    const left =
      speedDuration * 60 -
      Math.floor((Date.now() - speedStart) / 1000);

    if(left <= 0){
      speedTimer.innerText = "SPEED ZAKO≈ÉCZONY";
      clearInterval(speedInterval);
      speedStart = null;
      saveSpeed();
      return;
    }

    speedTimer.innerText =
      `Pozosta≈Ço: ${String(Math.floor(left / 60)).padStart(2, "0")}:` +
      `${String(left % 60).padStart(2, "0")}`;
  }, 1000);
}

function trackExpTick(currentExp){
  if(!currentDay) return;

  const gained = currentExp - lastGlobalExp;
  if(gained <= 0) return;

  if(speedStart){
    const speedPart = Math.round(gained * (speedPercent / 100));
    currentDay.speedExp += speedPart;
    currentDay.normalExp += (gained - speedPart);
  } else {
    currentDay.normalExp += gained;
  }

  lastGlobalExp = currentExp;
  localStorage.setItem(key("currentDay"), JSON.stringify(currentDay));
}


/* DAY STATS */
let days=[];
let currentDay=null;
let lastGlobalExp=0;


function loadDays(){
  days=JSON.parse(localStorage.getItem(key("days"))||"[]");
  currentDay=JSON.parse(localStorage.getItem(key("currentDay"))||"null");
  renderDays();

  if(currentDay){
    dayStatus.innerText="DZIE≈É AKTYWNY";
  }else{
    dayStatus.innerText="‚Äî";
  }
}

async function startDay(){
  const d = await fetchPlayer();

currentDay={
  date:new Date().toLocaleDateString(),
  expStart:d.experience,
  lvlFrom:d.level,
  speedExp:0,
  normalExp:0
};
lastGlobalExp=d.experience;

  localStorage.setItem(key("currentDay"), JSON.stringify(currentDay));
  dayStatus.innerText = "DZIE≈É AKTYWNY";
}


async function endDay(){
  if(!currentDay) return;

  const d = await fetchPlayer();
  const total = currentDay.speedExp + currentDay.normalExp;

  days.push({
    date: currentDay.date,
    exp: total,
    speedExp: currentDay.speedExp,
    normalExp: currentDay.normalExp,
    pct: total ? Math.round(currentDay.speedExp / total * 100) : 0,
    lvls: `${currentDay.lvlFrom} ‚Üí ${d.level}`
  });

  localStorage.setItem(key("days"), JSON.stringify(days));
  localStorage.removeItem(key("currentDay"));
  currentDay = null;
  dayStatus.innerText = "‚Äî";
  renderDays();
}


function renderDays(){
  dayList.innerHTML="";
  days.forEach((d,i)=>{
    dayList.innerHTML+=`
    <div class="list-row">
      <div>${d.date}</div>
      <div>${d.exp.toLocaleString()}</div>
      <div>${d.speedExp.toLocaleString()}</div>
      <div>${d.normalExp.toLocaleString()}</div>
      <div>${d.pct}%</div>
      <div>${d.lvls}</div>
      <div><button onclick="delDay(${i})">X</button></div>
    </div>`;
  });
  renderChart();
  function updateSummary(){
  if(!days.length){
    sumExp.innerText="‚Äî";
    avgExp.innerText="‚Äî";
    daysCount.innerText="‚Äî";
    speedPct.innerText="‚Äî";
    return;
  }

  const total=days.reduce((a,b)=>a+b.exp,0);
  const speed=days.reduce((a,b)=>a+b.speedExp,0);

  sumExp.innerText=total.toLocaleString();
  avgExp.innerText=Math.round(total/days.length).toLocaleString();
  daysCount.innerText=days.length;
  speedPct.innerText=total?Math.round(speed/total*100)+"%":"0%";
}

}
function delDay(i){
  days.splice(i,1);
  localStorage.setItem(key("days"),JSON.stringify(days));
  renderDays();
}

/* CHART */
let chart=null;
function renderChart(){
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart)chart.destroy();

  const grad=ctx.createLinearGradient(0,0,0,300);
  grad.addColorStop(0,"rgba(255,80,80,.9)");
  grad.addColorStop(1,"rgba(255,80,80,.1)");

  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:days.map(d=>d.date),
      datasets:[{
        data:days.map(d=>d.exp),
        borderColor:"#ff4a4a",
        borderWidth:4,
        backgroundColor:grad,
        fill:true,
        tension:.35,
        pointRadius:4,
        pointBackgroundColor:"#ff4a4a"
      }]
    },
    options:{
      plugins:{
        legend:{display:false},
        tooltip:{
          callbacks:{
            label:(c)=>"EXP: "+c.parsed.y.toLocaleString()
          }
        }
      },
      scales:{
        x:{ticks:{color:"#ffd0d0"}},
        y:{ticks:{color:"#ffd0d0"}}
      }
    }
  });

  updateSummary();
}


/* INIT */
const speedPercentEl=document.getElementById("speedPercent");
function loadState(){
  loadSpeed();
  loadDays();
  initAuto();
}
if(char){
  refresh();
  loadState();
}
 

  /* CLOCK ‚Äì ZAWSZE WIDOCZNY */
function startClock(){
  const timeEl = document.getElementById("clockTime");
  const dateEl = document.getElementById("clockDate");

  if(!timeEl || !dateEl) return;

  function tick(){
    const n = new Date();
    timeEl.innerText = n.toLocaleTimeString();
    dateEl.innerText = n.toLocaleDateString();
  }

  tick();
  setInterval(tick, 1000);
}

startClock();

function syncDayStatus(){
  const cd = localStorage.getItem(key("currentDay"));
  if(cd){
    dayStatus.innerText = "DZIE≈É AKTYWNY";
  }else{
    dayStatus.innerText = "‚Äî";
  }
}

  if(char){
  refresh();
  loadState();
}
syncDayStatus();

</script>
<script src="/static/js/app.js"></script>

<script>
(function HARD_CLOCK(){
  console.log("HARD CLOCK INIT");

  let box = document.getElementById("clockBox");

  // je≈õli zegarka nie by≈Ço w HTML ‚Äì tworzymy go
  if(!box){
    box = document.createElement("div");
    box.id = "clockBox";
    box.innerHTML = `
      <div id="clockTime"></div>
      <div id="clockDate"></div>
    `;
    document.body.appendChild(box);
  }

  // wymuszamy widoczno≈õƒá (nadpisuje CSS)
  Object.assign(box.style, {
    position: "fixed",
    top: "20px",
    right: "30px",
    zIndex: "999999",
    color: "#ff6a6a",
    textShadow: "0 0 15px rgba(255,0,0,.7)",
    fontFamily: "Cinzel, serif",
    pointerEvents: "none",
    display: "block",
    opacity: "1",
    visibility: "visible"
  });

  const timeEl = box.querySelector("#clockTime");
  const dateEl = box.querySelector("#clockDate");

  function tick(){
    const n = new Date();
    timeEl.textContent = n.toLocaleTimeString();
    dateEl.textContent = n.toLocaleDateString();
  }

  tick();
  setInterval(tick, 1000);

  console.log("HARD CLOCK RUNNING");
})();
</script>


</body>
</html>

















