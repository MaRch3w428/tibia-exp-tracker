<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f3caca;
  background:
    linear-gradient(rgba(0,0,0,.82), rgba(0,0,0,.95)),
    url("/static/bg.jpg") center/cover no-repeat fixed;
}
header{text-align:center;padding:30px}
header img{max-width:420px;filter:drop-shadow(0 0 30px rgba(255,0,0,.9))}
.container{max-width:1200px;margin:auto;padding:20px}
.card{
  background:rgba(15,0,0,.55);
  border:1px solid rgba(255,0,0,.45);
  border-radius:16px;
  padding:26px;
  margin-bottom:26px;
}
.section-title{font-size:22px;color:#ff6a6a;margin-bottom:18px}
button,input{
  background:#0b0000;color:#ffd0d0;border:1px solid #aa2222;
  padding:8px 14px;font-family:'Cinzel',serif;cursor:pointer
}
.list-header,.list-row{
  display:grid;
  grid-template-columns:120px 110px 110px 110px 80px 130px 60px;
  gap:10px;
  font-size:14px;
}
.list-header{font-weight:bold;border-bottom:1px solid rgba(255,255,255,.2)}
.list-row{border-bottom:1px solid rgba(255,255,255,.08);padding:6px 0}
#charHero{text-align:center}
#vocationIcon{width:160px}
#charNameBig{font-size:40px;color:#ff4a4a}
#charStats{font-size:22px}
#expValue{font-size:38px;color:#ff4a4a;text-align:center;margin-top:16px}
#expBar{height:12px;background:#220000;border-radius:8px;overflow:hidden;margin-top:10px}
#expBar span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ff2a2a,#ff7a7a)}
footer{text-align:right;padding:10px 20px;font-size:12px;color:#aa5555}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro" style="position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;animation:introFade 4s forwards">
  <img src="/static/intro/logo.png" style="width:480px;max-width:90%;filter:drop-shadow(0 0 60px red);animation:introZoom 4s forwards">
</div>

<header>
  <img src="/static/header/apo-tracker.png">
</header>

<div class="container">

<!-- POSTAĆ -->
<div class="card">
  <div class="section-title">Postać</div>
  Nick:
  <input id="charInput">
  <button onclick="setChar()">Ustaw</button>

  <div id="charHero">
    <img id="vocationIcon">
    <div id="charNameBig">—</div>
    <div id="charStats">—</div>
  </div>
</div>

<!-- DOŚWIADCZENIE -->
<div class="card">
  <div class="section-title">DOŚWIADCZENIE</div>
  <button onclick="refresh()">Odśwież</button>
  <div id="expValue">—</div>
  <div id="expBar"><span></span></div>
</div>

<!-- SPEED -->
<div class="card">
  <div class="section-title">Speed</div>
  <button onclick="startSpeed()">START</button>
  <button onclick="stopSpeed()">STOP</button>
  <div id="speedInfo">—</div>
</div>

<!-- STATYSTYKI EXPIENIA -->
<div class="card">
  <div class="section-title">STATYSTYKI EXPIENIA</div>
  <button onclick="startDay()">START DNIA</button>
  <button onclick="endDay()">ZAKOŃCZ DZIEŃ</button>

  <div class="list-header">
    <div>Data</div><div>EXP</div><div>Speed</div><div>Normal</div><div>% Speed</div><div>Lvle</div><div>Usuń</div>
  </div>
  <div id="dayList"></div>
</div>

<!-- WYKRES -->
<div class="card">
  <div class="section-title">Wykres EXP</div>
  <canvas id="chart" height="120"></canvas>
</div>

</div>

<footer>
  designed by Zohanek © <span id="year"></span>
</footer>

<script>
year.innerText=new Date().getFullYear();

/* ===== STATE ===== */
let char=localStorage.getItem("char")||"";
charInput.value=char;

let days=JSON.parse(localStorage.getItem("daysAuto")||"[]");
let currentDay=null;
let speedStartExp=0,speedStartTime=0;
let chart=null;

/* ICON */
function iconFor(v){
  if(!v)return"rook.png";
  v=v.toLowerCase();
  if(v.includes("knight"))return"knight.png";
  if(v.includes("druid"))return"druid.png";
  if(v.includes("palad"))return"paladin.png";
  if(v.includes("czaro"))return"sorcerer.png";
  return"rook.png";
}

/* API */
async function fetchPlayer(){
  const r=await fetch(`/player/${char}`);
  return r.json();
}

/* SET CHAR */
function setChar(){
  char=charInput.value.trim();
  localStorage.setItem("char",char);
  refresh();
}

/* REFRESH */
async function refresh(){
  if(!char)return;
  const d=await fetchPlayer();
  vocationIcon.src="/static/icons/"+iconFor(d.vocation);
  charNameBig.innerText=d.name;
  charStats.innerText=`Level ${d.level} | Magic ${d.magic}`;
  expValue.innerText=d.experience.toLocaleString();
  document.querySelector("#expBar span").style.width="100%";
}

/* SPEED */
async function startSpeed(){
  const d=await fetchPlayer();
  speedStartExp=d.experience;
  speedStartTime=Date.now();
}
async function stopSpeed(){
  const d=await fetchPlayer();
  const gain=d.experience-speedStartExp;
  if(currentDay) currentDay.speedExp+=gain;
}

/* DAY */
async function startDay(){
  const d=await fetchPlayer();
  currentDay={
    date:new Date().toLocaleDateString(),
    expStart:d.experience,
    expEnd:0,
    speedExp:0,
    lvlFrom:d.level,
    lvlTo:0
  };
}
async function endDay(){
  if(!currentDay)return;
  const d=await fetchPlayer();
  currentDay.expEnd=d.experience;
  currentDay.lvlTo=d.level;

  const total=currentDay.expEnd-currentDay.expStart;
  const speed=currentDay.speedExp;
  const normal=total-speed;

  days.push({
    date:currentDay.date,
    exp:total,
    speedExp:speed,
    normalExp:normal,
    pct: total?Math.round(speed/total*100):0,
    lvls:`${currentDay.lvlFrom} → ${currentDay.lvlTo}`
  });

  localStorage.setItem("daysAuto",JSON.stringify(days));
  currentDay=null;
  renderDays();
}

/* RENDER DAYS */
function renderDays(){
  dayList.innerHTML="";
  days.forEach((d,i)=>{
    dayList.innerHTML+=`
      <div class="list-row">
        <div>${d.date}</div>
        <div>${d.exp.toLocaleString()}</div>
        <div>${d.speedExp.toLocaleString()}</div>
        <div>${d.normalExp.toLocaleString()}</div>
        <div>${d.pct}%</div>
        <div>${d.lvls}</div>
        <div><button onclick="delDay(${i})">X</button></div>
      </div>`;
  });
  renderChart();
}
function delDay(i){
  days.splice(i,1);
  localStorage.setItem("daysAuto",JSON.stringify(days));
  renderDays();
}

/* CHART */
function renderChart(){
  const ctx=document.getElementById("chart");
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:days.map(d=>d.date),
      datasets:[{data:days.map(d=>d.exp),borderColor:"#ff4a4a",tension:.3}]
    },
    options:{plugins:{legend:{display:false}}}
  });
}

/* INIT */
if(char)refresh();
renderDays();
</script>

</body>
</html>
