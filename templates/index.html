<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>APO Podkarpacki OTS Tracker</title>

<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@500;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:'Cinzel',serif;
  color:#f3caca;
  background:
    linear-gradient(rgba(0,0,0,.82), rgba(0,0,0,.95)),
    url("/static/bg.jpg") center/cover no-repeat fixed;
}

/* CLOCK */
#clockBox{
  position:fixed;
  top:20px;
  right:30px;
  text-align:right;
  z-index:3000;
  color:#ff6a6a;
  text-shadow:0 0 15px rgba(255,0,0,.7);
}
#clockTime{font-size:32px;font-weight:700}
#clockDate{font-size:16px;opacity:.85}

/* INTRO */
#intro{
  position:fixed;
  inset:0;
  background:
    linear-gradient(rgba(0,0,0,.6), rgba(0,0,0,.85)),
    url("/static/bg.jpg") center/cover no-repeat;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
#intro img{
  width:480px;
  max-width:90%;
  opacity:0;
  transform:scale(.85);
  animation:introIn 1.8s forwards;
}
@keyframes introIn{
  0%{opacity:0;transform:scale(.85)}
  60%{opacity:1;transform:scale(1.05)}
  100%{opacity:1;transform:scale(1)}
}

header{text-align:center;padding:30px}
header img{max-width:420px;filter:drop-shadow(0 0 30px rgba(255,0,0,.9))}

.container{max-width:1200px;margin:auto;padding:20px}

.card{
  background:rgba(15,0,0,.55);
  border:1px solid rgba(255,0,0,.45);
  border-radius:16px;
  padding:26px;
  margin-bottom:26px;
}

.section-title{font-size:22px;color:#ff6a6a;margin-bottom:18px}

button,input{
  background:#0b0000;
  color:#ffd0d0;
  border:1px solid #aa2222;
  padding:8px 14px;
  font-family:'Cinzel',serif;
  cursor:pointer;
}
button:hover{box-shadow:0 0 15px rgba(255,0,0,.7)}
button.active{animation:pulse 1.4s infinite}

@keyframes pulse{
  0%{box-shadow:0 0 10px red}
  50%{box-shadow:0 0 25px red}
  100%{box-shadow:0 0 10px red}
}

/* MAIN PANEL */
#charHero{text-align:center}
#vocationIcon{width:140px}
#charNameBig{font-size:38px;color:#ff4a4a}
#charStats{font-size:20px;margin-top:6px}
#expValue{font-size:36px;color:#ff4a4a;margin-top:10px}

/* SPEED */
#speedBox{text-align:center}
#speedPercent{font-size:52px;color:#ff4a4a}
.speedBtns button{margin:4px;min-width:60px}
.speedBtns button.active{box-shadow:0 0 25px red}
#speedTimer{font-size:26px;margin-top:10px}

/* LIST */
.list-header,.list-row{
  display:grid;
  grid-template-columns:120px 120px 120px 120px 90px 180px 60px;
  gap:10px;
}
.list-header{
  font-size:14px;
  font-weight:bold;
  border-bottom:1px solid rgba(255,255,255,.2);
}
.list-row{
  font-size:17px;
  padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,.1);
}

footer{text-align:right;padding:10px 20px;font-size:12px;color:#aa5555}
</style>
</head>

<body>

<div id="clockBox">
  <div id="clockTime"></div>
  <div id="clockDate"></div>
</div>

<div id="intro"><img src="/static/intro/logo.png"></div>

<header><img src="/static/header/apo-tracker.png"></header>

<div class="container">

<!-- MAIN PANEL -->
<div class="card">
  <div class="section-title">Postać</div>

  Nick:
  <input id="charInput">
  <button onclick="setChar()">USTAW</button>

  <div id="charHero">
    <img id="vocationIcon">
    <div id="charNameBig">—</div>
    <div id="charStats">—</div>
    <div id="expValue">—</div>
  </div>

  <div style="margin-top:15px">
    <button onclick="refresh()">Odśwież</button>
    <button id="autoBtn" onclick="toggleAuto()">Auto-odśwież: WYŁ</button>
  </div>
</div>

<!-- SPEED -->
<div class="card">
  <div class="section-title">Speed</div>

  <div id="speedBox">
    <div id="speedPercent">50%</div>

    <div class="speedBtns" id="speedBtns"></div>

    <div style="margin-top:10px">
      <label><input type="radio" name="speedTime" value="80"> 80 min</label>
      <label style="margin-left:20px">
        <input type="radio" name="speedTime" value="60"> 60 min</label>
    </div>

    <div style="margin-top:15px">
      <button onclick="startSpeed()">UŻYJ SPEEDA</button>
      <button onclick="resetSpeed()">RESTART SPEED</button>
    </div>

    <div id="speedTimer">—</div>
  </div>
</div>

<!-- DAY STATS -->
<div class="card">
  <div class="section-title">Statystyka dzienna</div>
  <button onclick="startDay()">START DNIA</button>
  <button onclick="endDay()">ZAKOŃCZ DZIEŃ</button>
  <div id="dayStatus">—</div>

  <div class="list-header">
    <div>Data</div><div>EXP</div><div>Speed</div><div>Normal</div><div>%</div><div>Lvle</div><div>Usuń</div>
  </div>
  <div id="dayList"></div>
</div>

<!-- CHART -->
<div class="card">
  <div class="section-title">Wykres EXP</div>
  <canvas id="chart" height="140"></canvas>
</div>

</div>

<footer>designed by Zohanek © <span id="year"></span></footer>

<script>
/* INTRO + CLOCK */
setTimeout(()=>intro.style.display="none",2600);
setInterval(()=>{
  const n=new Date();
  clockTime.innerText=n.toLocaleTimeString();
  clockDate.innerText=n.toLocaleDateString();
},1000);
year.innerText=new Date().getFullYear();

/* STATE */
let char=localStorage.getItem("char")||"";
charInput.value=char;

charInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") setChar();
});

let days=JSON.parse(localStorage.getItem("daysAuto")||"[]");
let currentDay=JSON.parse(localStorage.getItem("currentDay")||"null");

let speedSettings=JSON.parse(localStorage.getItem("speedSettings")||"{}");
let speedPercent=speedSettings.percent||50;
let speedDuration=speedSettings.duration||80;
let speedStart=speedSettings.startTime||null;
let speedInterval=null;

/* PROFESSION FIX (ETAP B) */
function parseVocation(raw){
  const v=String(raw).toLowerCase().trim();
  if(v==="rook") return {icon:"knight.png",name:"Rycerz"};
  return {icon:"rook.png",name:"Rook"};
}

/* API */
async function fetchPlayer(){
  const r=await fetch(`/player/${char}`);
  return r.json();
}

/* MAIN PANEL */
function setChar(){
  char=charInput.value.trim();
  localStorage.setItem("char",char);
  refresh();
}

async function refresh(){
  if(!char) return;
  const d=await fetchPlayer();
  const v=parseVocation(d.vocation);
  vocationIcon.src="/static/icons/"+v.icon;
  charNameBig.innerText=d.name;
  charStats.innerText=`${v.name} | Level ${d.level} | Magic ${d.magic}`;
  expValue.innerText=d.experience.toLocaleString();
}

/* AUTO REFRESH */
let autoTimer=null;
function toggleAuto(){
  const on=localStorage.getItem("autoRefresh")==="1";
  if(on){
    clearInterval(autoTimer);
    localStorage.setItem("autoRefresh","0");
    autoBtn.innerText="Auto-odśwież: WYŁ";
  }else{
    autoTimer=setInterval(refresh,600000);
    localStorage.setItem("autoRefresh","1");
    autoBtn.innerText="Auto-odśwież: WŁ";
  }
}
if(localStorage.getItem("autoRefresh")==="1"){
  toggleAuto();
}

/* SPEED UI */
const speedBtnsDiv=document.getElementById("speedBtns");
for(let i=5;i<=50;i+=5){
  const b=document.createElement("button");
  b.innerText=i+"%";
  if(i===speedPercent) b.classList.add("active");
  b.onclick=()=>{
    speedPercent=i;
    saveSpeed();
    renderSpeedBtns();
  };
  speedBtnsDiv.appendChild(b);
}
function renderSpeedBtns(){
  [...speedBtnsDiv.children].forEach(b=>{
    b.classList.toggle("active",b.innerText===speedPercent+"%");
  });
  speedPercentDiv.innerText=speedPercent+"%";
}
document.querySelectorAll('input[name="speedTime"]').forEach(r=>{
  r.checked=Number(r.value)===speedDuration;
  r.onchange=()=>{speedDuration=Number(r.value);saveSpeed();}
});
function saveSpeed(){
  localStorage.setItem("speedSettings",JSON.stringify({
    percent:speedPercent,
    duration:speedDuration,
    startTime:speedStart
  }));
}
function startSpeed(){
  speedStart=Date.now();
  saveSpeed();
  runTimer();
}
function resetSpeed(){
  speedPercent=50;
  speedDuration=80;
  speedStart=null;
  saveSpeed();
  renderSpeedBtns();
  speedTimer.innerText="—";
}
function runTimer(){
  clearInterval(speedInterval);
  speedInterval=setInterval(()=>{
    const left=speedDuration*60-
      Math.floor((Date.now()-speedStart)/1000);
    if(left<=0){
      speedTimer.innerText="SPEED ZAKOŃCZONY";
      clearInterval(speedInterval);
      return;
    }
    speedTimer.innerText=
      `Pozostało: ${String(Math.floor(left/60)).padStart(2,"0")}:${String(left%60).padStart(2,"0")}`;
  },1000);
}
if(speedStart) runTimer();

/* DAY STATS */
async function startDay(){
  const d=await fetchPlayer();
  currentDay={date:new Date().toLocaleDateString(),expStart:d.experience,speedExp:0,lvlFrom:d.level};
  localStorage.setItem("currentDay",JSON.stringify(currentDay));
  dayStatus.innerText="DZIEŃ AKTYWNY";
}
async function endDay(){
  if(!currentDay)return;
  const d=await fetchPlayer();
  const total=d.experience-currentDay.expStart;
  days.push({
    date:currentDay.date,
    exp:total,
    speedExp:currentDay.speedExp,
    normalExp:total-currentDay.speedExp,
    pct:total?Math.round(currentDay.speedExp/total*100):0,
    lvls:`${currentDay.lvlFrom} → ${d.level}`
  });
  localStorage.setItem("daysAuto",JSON.stringify(days));
  localStorage.removeItem("currentDay");
  currentDay=null;
  renderDays();
}

/* RENDER DAYS + CHART */
function renderDays(){
  dayList.innerHTML="";
  days.forEach((d,i)=>{
    dayList.innerHTML+=`
    <div class="list-row">
      <div>${d.date}</div>
      <div>${d.exp.toLocaleString()}</div>
      <div>${d.speedExp.toLocaleString()}</div>
      <div>${d.normalExp.toLocaleString()}</div>
      <div>${d.pct}%</div>
      <div>${d.lvls}</div>
      <div><button onclick="delDay(${i})">X</button></div>
    </div>`;
  });
  renderChart();
}
function delDay(i){
  days.splice(i,1);
  localStorage.setItem("daysAuto",JSON.stringify(days));
  renderDays();
}

/* CHART */
let chart=null;
function renderChart(){
  const ctx=document.getElementById("chart").getContext("2d");
  if(chart)chart.destroy();
  const grad=ctx.createLinearGradient(0,0,0,300);
  grad.addColorStop(0,"rgba(255,80,80,.9)");
  grad.addColorStop(1,"rgba(255,80,80,.1)");
  chart=new Chart(ctx,{
    type:"line",
    data:{
      labels:days.map(d=>d.date),
      datasets:[{
        data:days.map(d=>d.exp),
        borderColor:"#ff4a4a",
        borderWidth:4,
        backgroundColor:grad,
        fill:true,
        tension:.35,
        pointRadius:4
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:"#ffd0d0"}},
        y:{ticks:{color:"#ffd0d0"}}
      }
    }
  });
}

/* INIT */
if(char) refresh();
renderSpeedBtns();
renderDays();
</script>

</body>
</html>
